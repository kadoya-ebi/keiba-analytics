<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>早見表＋コース形状フィルタ v0.7（右回り/左回り/直線）</title>
<style>
  :root{--bg:#f7f7f9;--card:#fff;--border:#e5e7eb;--text:#111;--muted:#6b7280;--accent:#111}
  body{margin:0;background:linear-gradient(#fafafa,#f3f4f6);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:var(--text)}
  .wrap{max-width:1120px;margin:0 auto;padding:16px 16px 80px}
  h1{font-size:20px;margin:0 0 10px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.03);padding:16px;margin:12px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted);font-size:12px}
  button{font:inherit;cursor:pointer;border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  input,select{padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff}
  .seg{display:flex;gap:8px;flex-wrap:wrap}
  .seg button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .grid{display:grid;gap:8px}
  .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .stat{border:1px solid var(--border);border-radius:16px;padding:12px;background:#fff}
  .stat h3{font-size:12px;margin:0 0 6px;color:#555}
  .stat .v{font-size:20px;font-weight:700}
  .right{text-align:right}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#f7f7fb;border-bottom:1px solid var(--border);text-align:left;font-weight:600;padding:10px}
  tbody td{border-top:1px solid var(--border);padding:10px;font-size:14px}
  .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-right:4px}
</style>
</head>
<body>
<div class="wrap">
  <h1>早見表（コース→馬場→距離）＋ コース形状フィルタ</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="a_export">CSV書き出し</button>
        <label><span style="padding:8px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer;display:inline-block">CSV読み込み<input id="a_import" type="file" accept=".csv,text/csv" style="display:none"></span></label>
        <button id="a_clear">全消去</button>
      </div>
      <div class="muted">列：date,track,surface,distance,pass,last3f,cushion,moisture,going,course,turf_start,straight_len,course_shape,turn_dir</div>
    </div>
  </div>

  <div class="card">
    <div><strong>1) コース</strong></div>
    <div class="seg" id="segTrack"></div>
    <div style="height:6px"></div>
    <div><strong>2) 馬場</strong></div>
    <div class="seg" id="segSurface">
      <button data-surface="芝">芝</button>
      <button data-surface="ダ">ダート</button>
    </div>
    <div style="height:6px"></div>
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div><strong>3) 距離</strong> <span class="muted" id="distanceNote"></span></div>
      <div class="row">
        <label class="muted">芝スタート <select id="fTurf"><option value="">指定なし</option><option value="true">あり</option><option value="false">なし</option></select></label>
        <label class="muted">直線 <select id="fStraight"><option value="">指定なし</option><option>長い</option><option>普通</option><option>短い</option></select></label>
        <label class="muted">コース形状 <select id="fShape"><option value="">指定なし</option><option>小回り</option><option>大回り</option></select></label>
        <label class="muted">回り <select id="fTurn"><option value="">指定なし</option><option>右回り</option><option>左回り</option><option>直線</option></select></label>
      </div>
    </div>
    <div class="seg" id="segDistance"></div>
    <div class="muted">基準通過：1000〜1200→600m、1400〜1600→800m、1800以上→1000m</div>
  </div>

  <div id="panel" class="card" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong id="title">—</strong>
      <div class="muted" id="count">—</div>
    </div>
    <div class="grid g-3" style="margin-top:8px">
      <div class="stat"><h3>平均 通過</h3><div class="v" id="avgPass">—</div></div>
      <div class="stat"><h3>平均 上がり3F</h3><div class="v" id="avgLast3f">—</div></div>
      <div class="stat"><h3>平均 クッション</h3><div class="v" id="avgCv">—</div></div>
      <div class="stat"><h3>平均 含水率(%)</h3><div class="v" id="avgMoist">—</div></div>
      <div class="stat"><h3>Pace 判定</h3><div class="v" id="pace">—</div></div>
      <div class="stat"><h3>基準ラベル</h3><div class="v" id="base">—</div></div>
    </div>
  </div>

  <details class="card">
    <summary><strong>明細（選択中の条件）</strong></summary>
    <div style="overflow:auto;border:1px solid var(--border);border-radius:12px;margin-top:8px">
      <table id="tbl">
        <thead><tr><th>日付</th><th>場</th><th>馬場</th><th class="right">距離</th><th>基準</th><th class="right">通過</th><th class="right">上がり3F</th><th class="right">CV</th><th class="right">含水</th><th>状態</th><th>コース</th><th>特性</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </details>

  <details class="card">
    <summary><strong>手入力（任意）</strong></summary>
    <div class="row" style="margin-top:8px">
      <input id="inDate" placeholder="日付 2025-10-23">
      <input id="inTrack" placeholder="競馬場">
      <select id="inSurface"><option>芝</option><option>ダ</option></select>
      <input id="inDistance" type="number" placeholder="距離(m)">
      <input id="inPass" type="number" step="0.01" placeholder="通過(秒)">
      <input id="inLast3f" type="number" step="0.01" placeholder="上がり3F(秒)">
      <input id="inCv" type="number" step="0.1" placeholder="クッション">
      <input id="inMo" type="number" step="0.1" placeholder="含水率(%)">
      <input id="inGoing" placeholder="状態 例: 良/稍/重">
      <input id="inCourse" placeholder="コース 例: A/内/外">
      <label>芝スタート<select id="inTurf"><option value="">—</option><option value="true">あり</option><option value="false">なし</option></select></label>
      <label>直線<select id="inStraight"><option value="">—</option><option>長い</option><option>普通</option><option>短い</option></select></label>
      <label>形状<select id="inShape"><option value="">—</option><option>小回り</option><option>大回り</option></select></label>
      <label>回り<select id="inTurn"><option value="">—</option><option>右回り</option><option>左回り</option><option>直線</option></select></label>
      <button id="btnAdd" class="primary">追加</button>
    </div>
  </details>

</div>

<script>
(function(){
  const ls = "keiba_cascade_rows_v07";
  const tracks = ["札幌","函館","福島","新潟","東京","中山","中京","京都","阪神","小倉"];
  const $ = (q, el=document)=> el.querySelector(q);
  const $$ = (q, el=document)=> Array.from(el.querySelectorAll(q));
  function load(){ try{ return JSON.parse(localStorage.getItem(ls))||[] }catch{ return [] } }
  function save(rows){ localStorage.setItem(ls, JSON.stringify(rows)); }
  function fmt(n, d=1){ return (n===undefined||n===null||!isFinite(n)) ? "—" : Number(n).toFixed(d); }
  function baseLabel(d){ if (!d) return ""; if (d<=1200) return "600m"; if (d<=1600) return "800m"; return "1000m"; }
  function uniq(a){ return Array.from(new Set(a)); }

  let rows = load();
  const state = {track:null, surface:null, distance:null};

  // Build track buttons
  const segT = $("#segTrack");
  tracks.forEach(t=>{
    const b=document.createElement("button"); b.textContent=t; b.dataset.track=t;
    b.onclick=()=>{ $$("#segTrack button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); state.track=t; renderDistances(); update(); };
    segT.appendChild(b);
  });
  // Surface
  $$("#segSurface button").forEach(b=> b.onclick=()=>{ $$("#segSurface button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); state.surface=b.dataset.surface; renderDistances(); update(); });

  // Filters
  $("#fTurf").addEventListener("change", update);
  $("#fStraight").addEventListener("change", update);
  $("#fShape").addEventListener("change", update);
  $("#fTurn").addEventListener("change", update);

  function renderDistances(){
    const seg=$("#segDistance"); seg.innerHTML="";
    let ds=[];
    if (state.track && state.surface){
      ds = uniq(rows.filter(r=> r.track===state.track && r.surface===state.surface).map(r=> Number(r.distance)).filter(Boolean)).sort((a,b)=>a-b);
      $("#distanceNote").textContent = ds.length? "（この場×馬場のCSV内の距離のみ表示）" : "（CSV未読込：代表的な距離を表示）";
    }
    if (ds.length===0){ ds=[1000,1100,1150,1200,1300,1400,1500,1600,1700,1800,1900,2000,2100,2200,2300,2400,2500,3000]; }
    ds.forEach(d=>{
      const b=document.createElement("button"); b.textContent=d; b.dataset.distance=d;
      b.onclick=()=>{ $$("#segDistance button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); state.distance=Number(d); update(); };
      seg.appendChild(b);
    });
  }

  function applyFilters(r){
    const fT = $("#fTurf").value;
    const fS = $("#fStraight").value;
    const fC = $("#fShape").value;
    const fR = $("#fTurn").value;
    if (fT!=="" && String(r.turf_start) !== fT) return false;
    if (fS!=="" && (r.straight_len||"") !== fS) return false;
    if (fC!=="" && (r.course_shape||"") !== fC) return false;
    if (fR!=="" && (r.turn_dir||"") !== fR) return false;
    return true;
  }

  function filtered(){
    return rows.filter(r=> (!state.track || r.track===state.track) && (!state.surface || r.surface===state.surface) && (!state.distance || Number(r.distance)===Number(state.distance)) && applyFilters(r));
  }

  function update(){
    const arr = filtered();
    const panel = $("#panel");
    if (!state.track || !state.surface || !state.distance){ panel.style.display="none"; return; }
    panel.style.display="";
    $("#title").textContent = `${state.track}・${state.surface}・${state.distance}m`;
    $("#count").textContent = `${arr.length} 件`;
    $("#base").textContent = baseLabel(state.distance)||"—";

    const avg = (a)=> a.length? a.reduce((s,v)=>s+v,0)/a.length : NaN;
    const nums = (k)=> arr.map(x=>x[k]).filter(v=>isFinite(v));
    const passAvg=avg(nums("pass")), lastAvg=avg(nums("last3f")), cvAvg=avg(nums("cushion")), moAvg=avg(nums("moisture"));
    $("#avgPass").textContent=fmt(passAvg);
    $("#avgLast3f").textContent=fmt(lastAvg);
    $("#avgCv").textContent=fmt(cvAvg);
    $("#avgMoist").textContent=fmt(moAvg);
    let delta; if (isFinite(passAvg) && isFinite(lastAvg)){ const baseM = state.distance<=1200?600: state.distance<=1600?800:1000; delta = (lastAvg/3) - (passAvg/(baseM/200)); }
    let pace="—"; if (isFinite(delta)){ if (delta<-0.3) pace="H"; else if (delta>0.3) pace="S"; else pace="M"; }
    $("#pace").innerHTML = `<span class="tag">${pace}</span>`;

    // Details
    const tbody=$("#tbl tbody"); tbody.innerHTML="";
    arr.slice(0,500).forEach(r=>{
      const tags = [];
      if (typeof r.turf_start==="boolean") tags.push(r.turf_start? "芝S":"土S");
      if (r.straight_len) tags.push("直線:"+r.straight_len);
      if (r.course_shape) tags.push(r.course_shape);
      if (r.turn_dir) tags.push(r.turn_dir);
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${r.date||""}</td><td>${r.track||""}</td><td>${r.surface||""}</td><td class="right">${r.distance||""}</td><td>${baseLabel(Number(r.distance)||0)}</td><td class="right">${fmt(r.pass)}</td><td class="right">${fmt(r.last3f)}</td><td class="right">${fmt(r.cushion)}</td><td class="right">${fmt(r.moisture)}</td><td>${r.going||""}</td><td>${r.course||""}</td><td>${tags.map(x=>`<span class='tag'>${x}</span>`).join(" ")}</td>`;
      tbody.appendChild(tr);
    });
  }

  // CSV import/export
  document.getElementById("a_export").onclick=()=>{
    const header=["date","track","surface","distance","pass","last3f","cushion","moisture","going","course","turf_start","straight_len","course_shape","turn_dir"];
    const lines=[header.join(",")].concat(rows.map(r=> header.map(k=> {
      const v = r[k]; if (typeof v==="boolean") return v? "true":"false"; return v??"";
    }).join(",")));
    const blob=new Blob([lines.join("\\n")],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="keiba_rows_with_course_dir.csv"; a.click(); URL.revokeObjectURL(url);
  };
  document.getElementById("a_import").addEventListener("change", e=>{
    const f=e.target.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const text=String(fr.result); const lines=text.split(/\\r?\\n/).filter(Boolean); const head=lines[0].split(",");
        const idx=k=> head.indexOf(k);
        const toNum=v=>{ const n=Number(v); return isFinite(n)?n:undefined; };
        const toBool=v=> v===undefined? undefined : (String(v).toLowerCase()==="true");
        rows = lines.slice(1).map(line=>{
          const c=line.split(",");
          return {
            date:c[idx("date")]||"", track:c[idx("track")]||"", surface:c[idx("surface")]||"",
            distance: toNum(c[idx("distance")]), pass: toNum(c[idx("pass")]), last3f: toNum(c[idx("last3f")]),
            cushion: toNum(c[idx("cushion")]), moisture: toNum(c[idx("moisture")]), going:c[idx("going")]||"", course:c[idx("course")]||"",
            turf_start: (idx("turf_start")>=0? toBool(c[idx("turf_start")]) : undefined),
            straight_len: (idx("straight_len")>=0? (c[idx("straight_len")]||"") : ""),
            course_shape: (idx("course_shape")>=0? (c[idx("course_shape")]||"") : ""),
            turn_dir: (idx("turn_dir")>=0? (c[idx("turn_dir")]||"") : "")
          };
        }).filter(r=> r.track && r.surface && r.distance);
        save(rows); renderDistances(); update(); alert("CSVを読み込みました");
      }catch(err){ alert("CSV読み込みエラー: "+err); }
      e.target.value="";
    };
    fr.readAsText(f);
  });
  document.getElementById("a_clear").onclick=()=>{ if(confirm("全データを削除しますか？")){ rows=[]; save(rows); renderDistances(); update(); } };

  // Manual add
  $("#btnAdd").onclick=()=>{
    const rec = {
      date: $("#inDate").value.trim(),
      track: $("#inTrack").value.trim(),
      surface: $("#inSurface").value,
      distance: Number($("#inDistance").value)||undefined,
      pass: $("#inPass").value===""? undefined : Number($("#inPass").value),
      last3f: $("#inLast3f").value===""? undefined : Number($("#inLast3f").value),
      cushion: $("#inCv").value===""? undefined : Number($("#inCv").value),
      moisture: $("#inMo").value===""? undefined : Number($("#inMo").value),
      going: $("#inGoing").value.trim(),
      course: $("#inCourse").value.trim(),
      turf_start: (function(v){ if(v==="") return undefined; return v==="true"; })($("#inTurf").value),
      straight_len: $("#inStraight").value || "",
      course_shape: $("#inShape").value || "",
      turn_dir: $("#inTurn").value || ""
    };
    if (!rec.track || !rec.surface || !rec.distance){ alert("場・馬場・距離は必須"); return; }
    rows = [rec, ...rows]; save(rows);
    ["inDate","inTrack","inDistance","inPass","inLast3f","inCv","inMo","inGoing","inCourse"].forEach(id=> $("#"+id).value="");
    $("#inTurf").value=""; $("#inStraight").value=""; $("#inShape").value=""; $("#inTurn").value="";
    renderDistances(); update(); alert("追加しました");
  };

  // default select
  setTimeout(()=>{ $$("#segTrack button")[0]?.click(); $$("#segSurface button")[0]?.click(); },0);
})();
</script>
</body>
</html>
