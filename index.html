<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>JRAコース早見テスト</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;background:#f3f5f6;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;}
    header{background:#0f766e;color:#fff;padding:14px 16px 8px;}
    .tabs{display:flex;gap:8px;background:#d7ebe9;padding:10px 14px 6px;}
    .tab-btn{flex:1;border:none;background:rgba(15,118,110,.35);color:#fff;border-radius:999px;padding:8px 0 7px;font-weight:600;font-size:.8rem;}
    .tab-btn.active{background:#fff;color:#0f766e;}
    main{padding:14px;max-width:820px;margin:0 auto;}
    .card{background:#fff;border-radius:16px;padding:14px;margin-bottom:14px;}
    .row{display:flex;gap:8px;flex-wrap:wrap;}
    .col{flex:1 1 30%;min-width:110px;}
    label{display:block;font-size:.65rem;margin-bottom:3px;color:#6b7280;}
    select,input{width:100%;padding:7px 8px;border:1px solid #dbe2e5;border-radius:12px;}
    .course-card{border-radius:16px;padding:12px;}
    .course-title{display:flex;gap:8px;align-items:center;margin-bottom:4px;}
    .tag{display:inline-block;padding:3px 9px 2px;border-radius:999px;font-size:.7rem;font-weight:600;color:#fff;}
    .pill-grid{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;}
    .pill{background:#fff;border-radius:10px;padding:4px 8px 3px;min-width:80px;}
    .lbl{font-size:.6rem;opacity:.7;}
    .val{font-size:.85rem;font-weight:600;}
    .bar{width:100%;height:10px;background:#dbe5eb;border-radius:999px;overflow:hidden;margin-bottom:4px;}
    .bar-inner{height:100%;}
    .bar-line{display:flex;justify-content:space-between;font-size:.65rem;}
    .track-input{border-bottom:1px solid rgba(0,0,0,.03);padding:10px 0;}
    .input-line{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:5px;}
    .small-inp{flex:0 0 70px;}
    .time-box {text-align: center;font-size: 1.1em;background-color: #f5f5f5;padding: 8px 12px;border-radius: 8px;
  margin: 8px 0;white-space: nowrap; /* ←これを追加 */}
    .small-btn{border:none;background:#0f766e;color:#fff;border-radius:10px;padding:3px 10px;font-size:.7rem;}
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:1rem;">JRAコース早見テスト</h1>
    <small>タブ2で入れたらタブ1に出るテスト</small>
  </header>
  <div class="tabs">
    <button class="tab-btn active" data-tab="view">タブ1：見る</button>
    <button class="tab-btn" data-tab="input">タブ2：入力</button>
  </div>
  <main>
    <!-- タブ1 -->
    <div id="tab-view">
      <div class="card">
        <div class="row">
          <div class="col">
            <label>競馬場</label>
            <select id="selTrack"></select>
          </div>
          <div class="col">
            <label>馬場</label>
            <select id="selSurface">
              <option value="芝">芝</option>
              <option value="ダート">ダート</option>
            </select>
          </div>
          <div class="col">
            <label>距離</label>
            <select id="selDist"></select>
          </div>
        </div>
      </div>
      <div id="courseInfo"></div>
    </div>

    <!-- タブ2 -->
    <div id="tab-input" style="display:none;">
      <div class="card">
        <p style="font-size:.7rem;margin-bottom:6px;">ここに今日のクッション値・含水率を入れると、タブ1に出ます。</p>
        <div id="inputList"></div>
      </div>
    </div>
  </main>

  <!-- 👇ここからJS。HTMLより後ろに置くことが大事 -->
  <script>
    // 1) ベースデータ（テスト用に4場だけ）
    var COURSES = {
      "東京": {
        "芝": { distances:[1600,2000], info:{}, base:{pass:58.0,last3f:34.0} },
        "ダート": { distances:[1600], info:{}, base:{pass:61.0,last3f:36.5} }
      },
      "中山": {
        "芝": { distances:[2000], info:{}, base:{pass:59.5,last3f:35.0} },
        "ダート": { distances:[1800], info:{}, base:{pass:62.0,last3f:37.0} }
      },
      "京都": {
        "芝": { distances:[2000], info:{}, base:{pass:58.8,last3f:34.6} },
        "ダート": { distances:[1800], info:{}, base:{pass:61.5,last3f:37.2} }
      },
      "阪神": {
        "芝": { distances:[1600], info:{}, base:{pass:58.7,last3f:34.5} },
        "ダート": { distances:[1800], info:{}, base:{pass:62.4,last3f:37.0} }
      }
    };

    // 2) 今日の値を入れておく箱
    var todayValues = {};
    var trackNames = Object.keys(COURSES);
    trackNames.forEach(function(t){
      todayValues[t] = {
        turf: { cushion:"", moisture:"" },
        dirt: { moisture:"" }
      };
    });

    // 3) DOM
    var selTrack = document.getElementById('selTrack');
    var selSurface = document.getElementById('selSurface');
    var selDist = document.getElementById('selDist');
    var courseInfo = document.getElementById('courseInfo');
    var inputList = document.getElementById('inputList');

    // 4) タブ切替
    var tabView = document.getElementById('tab-view');
    var tabInput = document.getElementById('tab-input');
    var tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(function(btn){
      btn.addEventListener('click', function(){
        tabBtns.forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        if (btn.dataset.tab === "view") {
          tabView.style.display = "block";
          tabInput.style.display = "none";
        } else {
          tabView.style.display = "none";
          tabInput.style.display = "block";
        }
      });
    });

    // 5) セレクト初期化
    function initSelectors(){
      trackNames.forEach(function(t){
        var opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        selTrack.appendChild(opt);
      });
      fillDistances();
    }
    function fillDistances(){
      var t = selTrack.value;
      var s = selSurface.value;
      selDist.innerHTML = "";
      COURSES[t][s].distances.forEach(function(d){
        var opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        selDist.appendChild(opt);
      });
    }
    selTrack.addEventListener('change', function(){ fillDistances(); renderCourse(); });
    selSurface.addEventListener('change', function(){ fillDistances(); renderCourse(); });
    selDist.addEventListener('change', renderCourse);

    // 6) タブ2の入力欄を作る（ここが今回のポイント）
    function renderInputList(){
      inputList.innerHTML = "";
      trackNames.forEach(function(t){
        var wrap = document.createElement('div');
        wrap.className = "track-input";
        wrap.innerHTML =
          '<div style="font-weight:700;margin-bottom:4px;">'+t+'</div>'+
          '<div class="input-line">'+
            '<span style="font-size:.65rem;">芝C</span>'+
            '<input type="number" step="0.1" class="small-inp" data-track="'+t+'" data-field="turf.cushion" placeholder="10" />'+
            '<span style="font-size:.65rem;">芝含</span>'+
            '<input type="number" step="0.1" class="small-inp" data-track="'+t+'" data-field="turf.moisture" placeholder="20" />'+
          '</div>'+
          '<div class="input-line">'+
            '<span style="font-size:.65rem;">ダ含</span>'+
            '<input type="number" step="0.1" class="small-inp" data-track="'+t+'" data-field="dirt.moisture" placeholder="5" />'+
            '<button class="small-btn" data-apply="'+t+'">反映</button>'+
          '</div>';
        inputList.appendChild(wrap);
      });

      // 入力した瞬間に保存＋表示更新
      var allInputs = inputList.querySelectorAll('input[data-track]');
      allInputs.forEach(function(inp){
        inp.addEventListener('input', function(){
          var t = inp.dataset.track;
          var f = inp.dataset.field;
          var v = inp.value;
          if (f === "turf.cushion")  todayValues[t].turf.cushion = v;
          if (f === "turf.moisture") todayValues[t].turf.moisture = v;
          if (f === "dirt.moisture") todayValues[t].dirt.moisture = v;
          // 今タブ1でこの競馬場を見てたら更新
          if (selTrack.value === t) {
            renderCourse();
          }
        });
      });

      // ボタンでも一応反映できるようにしておく
      var btns = inputList.querySelectorAll('button[data-apply]');
      btns.forEach(function(b){
        b.addEventListener('click', function(){
          var t = b.dataset.apply;
          var ins = inputList.querySelectorAll('input[data-track="'+t+'"]');
          ins.forEach(function(inp){
            var f = inp.dataset.field;
            var v = inp.value;
            if (f === "turf.cushion")  todayValues[t].turf.cushion = v;
            if (f === "turf.moisture") todayValues[t].turf.moisture = v;
            if (f === "dirt.moisture") todayValues[t].dirt.moisture = v;
          });
          if (selTrack.value === t) {
            renderCourse();
          }
        });
      });
    }

    // 7) タブ1の表示
    function renderCourse(){
      var t = selTrack.value;
      var s = selSurface.value;
      var d = Number(selDist.value);
      var data = COURSES[t][s];
      var info = data.info[d] || null;
      var avg = data.base;
      var tv = todayValues[t];

      var cTxt = "-";
      var mTxt = "-%";
      var cVal = 0;
      var mVal = 0;
      if (s === "芝") {
        if (tv.turf.cushion !== "") { cTxt = tv.turf.cushion; cVal = Number(tv.turf.cushion); }
        if (tv.turf.moisture !== "") { mTxt = tv.turf.moisture + "%"; mVal = Number(tv.turf.moisture); }
      } else {
        if (tv.dirt.moisture !== "") { mTxt = tv.dirt.moisture + "%"; mVal = Number(tv.dirt.moisture); }
      }

      var cardBg = (s === "芝") ? "#e6f7e1" : "#d6b38a";
      var tagBg  = (s === "芝") ? "#22c55e" : "#8b4513";

      var cW = Math.min(cVal * 9, 100);
      var cColor = "#dbe5eb";
      if (s === "芝" && cVal > 0) {
        if (cVal <= 8) cColor = "#f97316";
        else if (cVal <= 10) cColor = "#84cc16";
        else cColor = "#60a5fa";
      }
      var mW = Math.min(mVal * 3.3, 100);
      var mColor = "#dbe5eb";
      if (mVal > 0) {
        if (mVal <= 15) mColor = "#84cc16";
        else if (mVal <= 23) mColor = "#fbbf24";
        else mColor = "#f97316";
      }

      var html = '';
      html += '<div class="card course-card" style="background:'+cardBg+';">';
      html += '  <div class="course-title">';
      html += '    <span class="tag" style="background:'+tagBg+';">'+s+'</span>';
      html += '    <div>'+t+'・'+s+'・'+d+'m</div>';
      html += '  </div>';
      html += '  <div class="pill-grid">';
      html += '<div class="time-box"><strong>基準値：</strong>通過 '+avg.pass+'秒 ／ 上がり3F '+avg.last3f+'秒</div>';
      html += '  <div class="bar"><div class="bar-inner" style="width:'+cW+'%;background:'+cColor+';"></div></div>';
      html += '  <div class="bar-line"><span>'+(s==="芝"?(cTxt==="-"?"クッション値：未入力":"クッション値："+cTxt):"クッション値：芝のみ")+'</span><span>硬め ←→ 柔らかめ</span></div>';
      html += '  <div class="bar"><div class="bar-inner" style="width:'+mW+'%;background:'+mColor+';"></div></div>';
      html += '  <div class="bar-line"><span>'+(s==="芝"?"芝 含水："+mTxt:"ダート 含水："+mTxt)+'</span><span>良 ←→ 重・不良</span></div>';
      html += '</div>';
      courseInfo.innerHTML = html;
    }

    // 8) 初期化
    initSelectors();
    renderInputList();
    renderCourse();
  </script>
</body>
</html>
