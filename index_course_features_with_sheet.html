
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>馬場メーター＋履歴＋Googleシート連携</title>
<style>
  :root{ --bg:#f7f7f9;--card:#fff;--border:#e5e7eb;--text:#111;--muted:#6b7280; --turf:#e6f4e6; --dirt:#f0e0d0; }
  body{margin:0;background:linear-gradient(#fafafa,#f3f4f6);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:var(--text)}
  .wrap{max-width:1000px;margin:0 auto;padding:16px 16px 120px}
  h1{font-size:20px;margin:0 0 12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);padding:16px;margin:12px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,button,input,textarea{padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;font:inherit}
  .feat{border-radius:16px;padding:16px;border:1px solid var(--border);background:var(--card)}
  .feat.turf{background:var(--turf)}
  .feat.dirt{background:var(--dirt)}
  .muted{color:var(--muted);font-size:12px}
  .big{font-size:18px;font-weight:700;margin-bottom:4px}
  .bar{position:relative;height:16px;border-radius:999px;overflow:hidden;border:1px solid var(--border);background:#f0f0f0}
  .bar .fill{position:absolute;top:0;left:0;bottom:0;background:linear-gradient(90deg,#a3e635,#facc15,#f97316,#ef4444)}
  .bar .tick{position:absolute;top:-6px;width:2px;height:28px;background:#999;opacity:.6}
  .legend{display:flex;justify-content:space-between;font-size:12px;color:#444;margin-top:6px}
  .mini{font-size:14px;padding:8px 10px;border-radius:10px;border:1px solid var(--border)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;font-size:14px;text-align:left}
  th{background:#fafafa}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width:780px){ .grid{grid-template-columns:1fr 1fr} }
  code{background:#eef2ff;border:1px solid #e5e7eb;border-radius:8px;padding:2px 6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>コース特徴＋馬場メーター＋履歴（Googleシート連携）</h1>

  <!-- 設定 -->
  <div class="card">
    <strong>Googleシート連携 設定</strong>
    <div class="grid" style="margin-top:8px">
      <div>
        <div class="muted">A) 読み込みのみ（公開CSV）… シートを「ウェブに公開」→ <code>CSVリンク</code> をここへ</div>
        <input id="csvUrl" class="mini" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?gid=0&single=true&output=csv" style="width:100%">
        <div class="row" style="margin-top:6px"><button id="btnImportCsv">CSVを取り込む</button></div>
      </div>
      <div>
        <div class="muted">B) 読み書き（Apps Script API）… デプロイした <code>ウェブアプリURL</code> をここへ</div>
        <input id="scriptUrl" class="mini" placeholder="https://script.google.com/macros/s/AKfycbx.../exec" style="width:100%">
        <div class="row" style="margin-top:6px">
          <button id="btnPushRow">現在の値を1行追記</button>
          <button id="btnPushAll">履歴を一括同期</button>
        </div>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">※ 連携情報はこのブラウザだけに保存されます。</div>
  </div>

  <!-- セレクタ -->
  <div class="card">
    <div class="row">
      <label>競馬場 <select id="selTrack"></select></label>
      <label>馬場 <select id="selSurf"><option value="芝">芝</option><option value="ダ">ダート</option></select></label>
      <label>距離 <select id="selDist"></select></label>
      <button id="btnCopy">テキストをコピー</button>
    </div>
    <div class="muted">※ 距離一覧は今後追加・修正可。坂高／高低差は目安を含みます。</div>
  </div>

  <!-- コース特徴 -->
  <div class="card feat" id="card">
    <div class="big" id="title">—</div>
    <div id="line1">—</div>
    <div id="line2" style="margin-top:4px">—</div>
    <div class="muted" id="meta" style="margin-top:8px">—</div>
  </div>

  <!-- 馬場メーター -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>本日の馬場傾向（クッション値・含水率）</strong>
      <div class="row">
        <input id="inCv" type="number" step="0.1" placeholder="CV" class="mini" style="width:90px">
        <input id="inMo" type="number" step="0.1" placeholder="%水分" class="mini" style="width:100px">
        <input id="inDate" type="date" class="mini" style="width:150px">
        <button id="applyCond">反映</button>
        <button id="saveToday">今日として保存</button>
        <button id="clearCond">クリア</button>
      </div>
    </div>
    <div style="margin-top:8px">
      <div class="row" style="gap:12px;align-items:center">
        <div style="min-width:100px;font-weight:600">芝クッション</div>
        <div class="bar" id="barCv" style="flex:1">
          <div class="fill" style="width:0%"></div>
          <div class="tick" style="left:0%"></div>
          <div class="tick" style="left:25%"></div>
          <div class="tick" style="left:50%"></div>
          <div class="tick" style="left:75%"></div>
          <div class="tick" style="left:100%"></div>
        </div>
        <div id="labCv" style="min-width:70px;text-align:right" class="muted">—</div>
      </div>
      <div class="legend"><span>柔らかめ</span><span>—</span><span>—</span><span>硬め</span></div>
    </div>
    <div style="margin-top:10px">
      <div class="row" style="gap:12px;align-items:center">
        <div style="min-width:100px;font-weight:600">含水率</div>
        <div class="bar" id="barMo" style="flex:1">
          <div class="fill" style="width:0%"></div>
          <div class="tick" style="left:0%"></div>
          <div class="tick" style="left:25%"></div>
          <div class="tick" style="left:50%"></div>
          <div class="tick" style="left:75%"></div>
          <div class="tick" style="left:100%"></div>
        </div>
        <div id="labMo" style="min-width:70px;text-align:right" class="muted">—</div>
      </div>
      <div class="legend"><span>良</span><span>稍重</span><span>重</span><span>不良</span></div>
    </div>
    <div class="muted" style="margin-top:6px">※ 目安：芝は 良≦10%、稍重≦15%、重≦20%。ダートは 良≦7%、稍重≦10%、重≦13% 目安。</div>
  </div>

  <!-- 履歴ロガー -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>履歴（ローカル保存）</strong>
      <div class="row">
        <select id="filterTrack" class="mini"></select>
        <select id="filterSurf" class="mini">
          <option value="">馬場(全部)</option>
          <option value="芝">芝</option>
          <option value="ダ">ダート</option>
        </select>
        <input id="filterFrom" type="date" class="mini">
        <input id="filterTo" type="date" class="mini">
        <button id="btnExport">CSVダウンロード</button>
        <button id="btnClearAll">全履歴クリア</button>
      </div>
    </div>
    <table id="tbl">
      <thead><tr><th>日付</th><th>競馬場</th><th>馬場</th><th>CV</th><th>含水%</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="muted">※ 履歴はブラウザのローカルに保存されます（このPC/ブラウザ限定）。</div>
  </div>

</div>

<script>
// ====== ダミーデータ（距離は必要最小限） ======
const DATA = {
 "東京":{meta:{turn:"左回り",straight:526,elev:2.0,slope_h:1.5,shape:"大回り"},
   "芝":{"1600":{note:"左回り・直線526m・ゴール前坂あり（坂高1.5m／高低差2.0m）・外回り"},
        "2400":{note:"左回り・直線526m・ゴール前坂あり（坂高1.5m／高低差2.0m）"}},
   "ダ":{"1600":{note:"左回り・直線501m・ゴール前坂あり・芝スタート",turf_start:true},
        "2100":{note:"左回り・直線501m・ゴール前坂あり"}}},
 "中山":{meta:{turn:"右回り",straight:310,elev:5.3,slope_h:2.4,shape:"小回り"},
   "芝":{"2000":{note:"右回り・直線310m・急坂あり（坂高2.4m／高低差5.3m）・内回り"}},
   "ダ":{"1800":{note:"右回り・直線308m・急坂あり（坂高2.4m／高低差5.3m）"}}}
};

// ====== LS keys ======
const COND_LS = "keiba_today_condition_full_v1";
const HIST_LS = "keiba_condition_history_v1";
const CFG_LS  = "keiba_sheet_cfg_v1";

// ====== helper ======
const $ = (q, el=document)=> el.querySelector(q);
function loadJSON(key){ try{ return JSON.parse(localStorage.getItem(key))||{} }catch(e){ return {} } }
function saveJSON(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }

// ====== init selectors ======
const selT = $("#selTrack"), selS = $("#selSurf"), selD = $("#selDist");
const title = $("#title"), line1 = $("#line1"), line2 = $("#line2"), meta = $("#meta"), card = $("#card");
const inCv = $("#inCv"), inMo = $("#inMo"), inDate = $("#inDate");
const csvUrl = $("#csvUrl"), scriptUrl = $("#scriptUrl");

function init(){
  // restore cfg
  const cfg = loadJSON(CFG_LS);
  csvUrl.value = cfg.csvUrl || "";
  scriptUrl.value = cfg.scriptUrl || "";

  // tracks
  Object.keys(DATA).forEach(t=>{
    const o=document.createElement('option'); o.value=t; o.textContent=t; selT.appendChild(o);
    const o2=o.cloneNode(true); $("#filterTrack").appendChild(o2);
  });
  $("#filterTrack").insertAdjacentHTML('afterbegin','<option value="">競馬場(全部)</option>');
  selT.value = "東京"; selS.value = "芝";

  // handlers
  selT.onchange = onChangeSel;
  selS.onchange = onChangeSel;
  selD.onchange = render;
  $("#btnCopy").onclick = copyText;
  $("#applyCond").onclick = applyCond;
  $("#saveToday").onclick = saveToday;
  $("#clearCond").onclick = clearCond;
  $("#btnExport").onclick = exportCSV;
  $("#btnClearAll").onclick = clearAllHistory;
  $("#filterTrack").onchange = drawTable;
  $("#filterSurf").onchange = drawTable;
  $("#filterFrom").onchange = drawTable;
  $("#filterTo").onchange = drawTable;
  $("#btnImportCsv").onclick = importCsvHistory;
  $("#btnPushRow").onclick = pushCurrentRow;
  $("#btnPushAll").onclick = pushAllRows;

  refreshDists(); restoreCond(); drawTable();
}

function onChangeSel(){ refreshDists(); restoreCond(); }

function refreshDists(){
  selD.innerHTML="";
  const t = selT.value, s = selS.value;
  const dists = Object.keys(DATA[t][s]).sort((a,b)=>Number(a)-Number(b));
  dists.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; selD.appendChild(o); });
  render();
}

function render(){
  const t=selT.value, s=selS.value, d=selD.value;
  const metaInfo = DATA[t].meta;
  const rec = DATA[t][s][d];
  title.textContent = `${t}・${s}・${d}m`;
  const turn = metaInfo.turn, straight = metaInfo.straight, elev = metaInfo.elev, slope_h = metaInfo.slope_h, shape = metaInfo.shape;
  card.classList.remove('turf','dirt'); card.classList.add(s==="芝" ? 'turf':'dirt');
  line1.textContent = rec?.note || "（準備中）";
  line2.textContent = s==="ダ" && rec?.turf_start ? "芝スタート距離です。" : "";
  meta.textContent = `基本情報：${turn}／直線${straight}m／高低差${elev}m／坂高${slope_h}m／形状${shape}`;
}

// ====== bars ======
function setBar(barId, labelId, value, min, max, formatter){
  const pct = Math.max(0, Math.min(100, (value-min) * 100 / (max-min)));
  const bar = document.getElementById(barId).querySelector(".fill");
  bar.style.width = isFinite(pct)? (pct + "%") : "0%";
  document.getElementById(labelId).textContent = formatter(value);
}
function labelMoist(val, surface){
  if (!isFinite(val)) return "—";
  const t = surface==="芝" ? [10,15,20] : [7,10,13];
  const lab = (val<=t[0]?"良": val<=t[1]?"稍重": val<=t[2]?"重":"不良");
  return `${lab} ${val.toFixed(1)}%`;
}
function labelCv(val){ return isFinite(val)? ("CV " + val.toFixed(1)) : "—"; }
function updateBars(){
  const t=selT.value, s=selS.value;
  const key = t + "|" + s;
  const cond = loadJSON(COND_LS)[key];
  if (cond && isFinite(cond.cushion)){
    setBar("barCv", "labCv", cond.cushion, 7.0, 11.5, labelCv);
  }else setBar("barCv", "labCv", 0, 7.0, 11.5, ()=>"—");
  if (cond && isFinite(cond.moisture)){
    setBar("barMo", "labMo", cond.moisture, 0, 25, v=> labelMoist(v, s));
  }else setBar("barMo", "labMo", 0, 25, v=> "—");
  inCv.value = (cond && isFinite(cond.cushion)) ? cond.cushion : "";
  inMo.value = (cond && isFinite(cond.moisture)) ? cond.moisture : "";
  inDate.value = (cond && cond.date) ? cond.date : new Date().toISOString().slice(0,10);
}

// ====== state ops ======
function applyCond(){
  const t=selT.value, s=selS.value;
  const key = t + "|" + s;
  const cv = Number(inCv.value);
  const mo = Number(inMo.value);
  const dt = inDate.value || new Date().toISOString().slice(0,10);
  const store = loadJSON(COND_LS);
  store[key] = { cushion: isFinite(cv)?cv:undefined, moisture: isFinite(mo)?mo:undefined, date: dt };
  saveJSON(COND_LS, store);
  updateBars();
}
function saveToday(){
  applyCond();
  const t=selT.value, s=selS.value; const key = t + "|" + s;
  const cond = loadJSON(COND_LS)[key]; if (!cond) return;
  const hist = loadJSON(HIST_LS); if (!hist.list) hist.list = [];
  hist.list.push({ date: cond.date, track: t, surface: s, cushion: cond.cushion, moisture: cond.moisture });
  saveJSON(HIST_LS, hist);
  drawTable();
}
function clearCond(){
  const t=selT.value, s=selS.value; const key = t + "|" + s;
  const store = loadJSON(COND_LS); delete store[key]; saveJSON(COND_LS, store);
  updateBars(); inCv.value=""; inMo.value="";
}
function restoreCond(){ updateBars(); }

async function copyText(){
  const t=selT.value, s=selS.value; const key = t + "|" + s;
  const cond = loadJSON(COND_LS)[key];
  const todayLine = cond? `\n[本日の馬場] CV ${cond.cushion ?? "—"} / 含水 ${cond.moisture ?? "—"}% (${cond.date ?? ""})` : "";
  const text = `${title.textContent}\n${line1.textContent}\n${line2.textContent? line2.textContent+"\n":""}${meta.textContent}${todayLine}`;
  try{ await navigator.clipboard.writeText(text); alert("コピーしました"); }catch(e){ alert("コピーできませんでした"); }
}

// ====== table & export ======
function drawTable(){
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML="";
  const hist = loadJSON(HIST_LS).list || [];
  const ft = document.getElementById("filterTrack").value,
        fs = document.getElementById("filterSurf").value,
        ffrom = document.getElementById("filterFrom").value,
        fto = document.getElementById("filterTo").value;
  const rows = hist.filter(r=> (!ft || r.track===ft) && (!fs || r.surface===fs) && (!ffrom || r.date>=ffrom) && (!fto || r.date<=fto))
                   .sort((a,b)=> a.date<b.date?1:-1);
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.date||""}</td><td>${r.track}</td><td>${r.surface}</td><td>${(r.cushion ?? "").toString()}</td><td>${(r.moisture ?? "").toString()}</td>`;
    tbody.appendChild(tr);
  }
}
function exportCSV(){
  const hist = loadJSON(HIST_LS).list || [];
  const ft = document.getElementById("filterTrack").value, fs = document.getElementById("filterSurf").value,
        ffrom = document.getElementById("filterFrom").value, fto = document.getElementById("filterTo").value;
  const rows = hist.filter(r=> (!ft || r.track===ft) && (!fs || r.surface===fs) && (!ffrom || r.date>=ffrom) && (!fto || r.date<=fto));
  const header = ["date","track","surface","cushion","moisture"];
  const lines = [header.join(",")].concat(rows.map(r=> header.map(k=> {
      const v = r[k]; if (v == null) return "";
      const s = String(v);
      const needs = s.includes(",") || s.includes('"') || s.includes("\n");
      const esc = s.replaceAll('"','""');
      return needs ? '"' + esc + '"' : esc;
  }).join(",")));
  const csv = lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = "keiba_condition_history.csv";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
}
function clearAllHistory(){
  if (!confirm("履歴をすべて削除します。よろしいですか？")) return;
  localStorage.removeItem(HIST_LS); drawTable();
}

// ====== Googleシート連携 ======
function saveCfg(){ saveJSON(CFG_LS, { csvUrl: csvUrl.value.trim(), scriptUrl: scriptUrl.value.trim() }); }

async function importCsvHistory(){
  saveCfg();
  const url = csvUrl.value.trim();
  if (!url){ alert("CSVの公開URLを入力してください。"); return; }
  try{
    const res = await fetch(url, {cache:"no-store"});
    const text = await res.text();
    // 期待カラム: date,track,surface,cushion,moisture（ヘッダ1行）
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length){ alert("CSVが空でした"); return; }
    const head = lines.shift().split(",");
    const idx = (k)=> head.findIndex(h=> h.trim().toLowerCase()===k);
    const idDate=idx("date"), idTrack=idx("track"), idSurf=idx("surface"), idCv=idx("cushion"), idMo=idx("moisture");
    if ([idDate,idTrack,idSurf,idCv,idMo].some(i=> i<0)){
      alert("CSVヘッダは date,track,surface,cushion,moisture が必要です");
      return;
    }
    const hist = loadJSON(HIST_LS); if (!hist.list) hist.list = [];
    for(const line of lines){
      if (!line.trim()) continue;
      const cols = line.split(",");
      hist.list.push({
        date: cols[idDate]?.trim()||"",
        track: cols[idTrack]?.trim()||"",
        surface: cols[idSurf]?.trim()||"",
        cushion: cols[idCv]? Number(cols[idCv]): undefined,
        moisture: cols[idMo]? Number(cols[idMo]): undefined,
      });
    }
    saveJSON(HIST_LS, hist);
    drawTable();
    alert("CSVを取り込みました");
  }catch(e){
    console.error(e); alert("CSVの取得に失敗しました");
  }
}

async function pushCurrentRow(){
  saveCfg();
  const url = scriptUrl.value.trim();
  if (!url){ alert("Apps ScriptのURLを入力してください。"); return; }
  const t=selT.value, s=selS.value;
  const key = t + "|" + s;
  const cond = loadJSON(COND_LS)[key];
  if (!cond){ alert("まずCV/含水率を入れて『反映→今日として保存』してください"); return; }
  const row = {date: cond.date, track: t, surface: s, cushion: cond.cushion, moisture: cond.moisture};
  try{
    const res = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({rows:[row]})});
    if (!res.ok) throw new Error("HTTP "+res.status);
    alert("1行をシートへ送信しました");
  }catch(e){
    console.error(e); alert("送信に失敗しました：権限/URL/デプロイ設定を確認してください");
  }
}

async function pushAllRows(){
  saveCfg();
  const url = scriptUrl.value.trim();
  if (!url){ alert("Apps ScriptのURLを入力してください。"); return; }
  const hist = loadJSON(HIST_LS).list || [];
  if (!hist.length){ alert("送信する履歴がありません"); return; }
  try{
    const res = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({rows:hist})});
    if (!res.ok) throw new Error("HTTP "+res.status);
    alert("履歴をシートへ一括送信しました");
  }catch(e){
    console.error(e); alert("送信に失敗しました：権限/URL/デプロイ設定を確認してください");
  }
}

init();
</script>
</body>
</html>
