<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>早見表＋コース形状フィルタ v1.0（内外・A〜D対応／プリセット管理）</title>
<style>
  :root{--bg:#f7f7f9;--card:#fff;--border:#e5e7eb;--text:#111;--muted:#6b7280;--accent:#111}
  body{margin:0;background:linear-gradient(#fafafa,#f3f4f6);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:var(--text)}
  .wrap{max-width:1180px;margin:0 auto;padding:16px 16px 96px}
  h1{font-size:20px;margin:0 0 10px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.03);padding:16px;margin:12px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted);font-size:12px}
  button{font:inherit;cursor:pointer;border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  input,select{padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:#fff}
  .seg{display:flex;gap:8px;flex-wrap:wrap}
  .seg button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .grid{display:grid;gap:8px}
  .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .stat{border:1px solid var(--border);border-radius:16px;padding:12px;background:#fff}
  .stat h3{font-size:12px;margin:0 0 6px;color:#555}
  .stat .v{font-size:20px;font-weight:700}
  .right{text-align:right}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#f7f7fb;border-bottom:1px solid var(--border);text-align:left;font-weight:600;padding:8px}
  tbody td{border-top:1px solid var(--border);padding:8px;font-size:14px}
  .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-right:4px;margin-top:4px}
  .tableWrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
  .hl{background:#fffbeb}
</style>
</head>
<body>
<div class="wrap">
  <h1>早見表（コース→馬場→距離）＋ コース形状フィルタ</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="a_export">CSV書き出し</button>
        <label><span style="padding:8px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer;display:inline-block">CSV読み込み<input id="a_import" type="file" accept=".csv,text/csv" style="display:none"></span></label>
        <button id="a_clear">全消去</button>
        <button id="a_preset" class="primary">プリセット適用</button>
      </div>
      <div class="muted">列：date,track,surface,distance,pass,last3f,cushion,moisture,going,course,course_variant,turf_start,straight_len,course_shape,turn_dir,finish_slope,straight_len_m,elevation_diff</div>
    </div>
    <div class="muted" style="margin-top:6px">
      ※ プリセットは「場・馬場」の基本値＋「内/外/A〜D」などの詳細を自動補完します。値は下の<span class="hl">プリセット管理</span>で編集可能。
    </div>
  </div>

  <div class="card">
    <div><strong>1) コース</strong></div>
    <div class="seg" id="segTrack"></div>
    <div style="height:6px"></div>
    <div><strong>2) 馬場</strong></div>
    <div class="seg" id="segSurface">
      <button data-surface="芝">芝</button>
      <button data-surface="ダ">ダート</button>
    </div>
    <div style="height:6px"></div>
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div><strong>3) 距離</strong> <span class="muted" id="distanceNote"></span></div>
      <div class="row">
        <label class="muted">芝スタート <select id="fTurf"><option value="">指定なし</option><option value="true">あり</option><option value="false">なし</option></select></label>
        <label class="muted">直線 <select id="fStraight"><option value="">指定なし</option><option>長い</option><option>普通</option><option>短い</option></select></label>
        <label class="muted">コース形状 <select id="fShape"><option value="">指定なし</option><option>小回り</option><option>大回り</option></select></label>
        <label class="muted">回り <select id="fTurn"><option value="">指定なし</option><option>右回り</option><option>左回り</option><option>直線</option></select></label>
        <label class="muted">内外/レール <select id="fVariant"><option value="">指定なし</option><option>内</option><option>外</option><option>A</option><option>B</option><option>C</option><option>D</option></select></label>
      </div>
    </div>
    <div class="seg" id="segDistance"></div>
    <div class="muted">基準通過：1000〜1200→600m、1400〜1600→800m、1800以上→1000m</div>
  </div>

  <div id="panel" class="card" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong id="title">—</strong>
      <div class="muted" id="count">—</div>
    </div>
    <div class="grid g-3" style="margin-top:8px">
      <div class="stat"><h3>平均 通過</h3><div class="v" id="avgPass">—</div></div>
      <div class="stat"><h3>平均 上がり3F</h3><div class="v" id="avgLast3f">—</div></div>
      <div class="stat"><h3>平均 クッション</h3><div class="v" id="avgCv">—</div></div>
      <div class="stat"><h3>平均 含水率(%)</h3><div class="v" id="avgMoist">—</div></div>
      <div class="stat"><h3>Pace 判定</h3><div class="v" id="pace">—</div></div>
      <div class="stat"><h3>基準ラベル</h3><div class="v" id="base">—</div></div>
    </div>
  </div>

  <details class="card">
    <summary><strong>明細（選択中の条件）</strong></summary>
    <div class="tableWrap" style="margin-top:8px">
      <table id="tbl">
        <thead><tr><th>日付</th><th>場</th><th>馬場</th><th class="right">距離</th><th>基準</th><th>Variant</th><th class="right">通過</th><th class="right">上がり3F</th><th class="right">CV</th><th class="right">含水</th><th>状態</th><th>コース</th><th>特性</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </details>

  <details class="card">
    <summary><strong>手入力（任意）</strong></summary>
    <div class="row" style="margin-top:8px">
      <input id="inDate" placeholder="日付 2025-10-23">
      <input id="inTrack" placeholder="競馬場">
      <select id="inSurface"><option>芝</option><option>ダ</option></select>
      <input id="inDistance" type="number" placeholder="距離(m)">
      <select id="inVariant"><option value="">Variant（内/外/A/B/C/D）</option><option>内</option><option>外</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
      <input id="inPass" type="number" step="0.01" placeholder="通過(秒)">
      <input id="inLast3f" type="number" step="0.01" placeholder="上がり3F(秒)">
      <input id="inCv" type="number" step="0.1" placeholder="クッション">
      <input id="inMo" type="number" step="0.1" placeholder="含水率(%)">
      <input id="inGoing" placeholder="状態 例: 良/稍/重">
      <input id="inCourse" placeholder="コース 例: A/内/外">
      <label>芝スタート<select id="inTurf"><option value="">—</option><option value="true">あり</option><option value="false">なし</option></select></label>
      <label>直線<select id="inStraight"><option value="">—</option><option>長い</option><option>普通</option><option>短い</option></select></label>
      <label>形状<select id="inShape"><option value="">—</option><option>小回り</option><option>大回り</option></select></label>
      <label>回り<select id="inTurn"><option value="">—</option><option>右回り</option><option>左回り</option><option>直線</option></select></label>
      <label>坂<select id="inSlope"><option value="">—</option><option>あり</option><option>なし</option></select></label>
      <input id="inStraightM" type="number" step="1" placeholder="直線距離(m) 例:525">
      <input id="inElev" type="number" step="0.1" placeholder="高低差(m) 例:2.0">
      <button id="btnAdd" class="primary">追加</button>
    </div>
  </details>

  <details class="card">
    <summary class="hl"><strong>プリセット管理（場×馬場×Variant の表）</strong></summary>
    <div class="row" style="justify-content:space-between;margin:8px 0">
      <div class="muted">※ ここで設定した値は <code>プリセット適用</code> で空欄へ自動反映されます</div>
      <div class="row">
        <button id="p_export">プリセットJSON書き出し</button>
        <label><span style="padding:8px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer;display:inline-block">プリセット読み込み<input id="p_import" type="file" accept=".json,application/json" style="display:none"></span></label>
        <button id="p_reset">初期プリセットに戻す</button>
      </div>
    </div>
    <div class="tableWrap">
      <table id="p_tbl">
        <thead><tr><th>場</th><th>馬場</th><th>Variant</th><th>回り</th><th>直線(長/普/短)</th><th>芝S</th><th>坂</th><th>直線距離(m)</th><th>高低差(m)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </details>

</div>

<script>
(function(){
  const ls = "keiba_cascade_rows_v10";
  const presetLS = "keiba_course_presets_v10";
  const tracks = ["札幌","函館","福島","新潟","東京","中山","中京","京都","阪神","小倉"];
  const $ = (q, el=document)=> el.querySelector(q);
  const $$ = (q, el=document)=> Array.from(el.querySelectorAll(q));
  function load(){ try{ return JSON.parse(localStorage.getItem(ls))||[] }catch{ return [] } }
  function save(rows){ localStorage.setItem(ls, JSON.stringify(rows)); }
  function fmt(n, d=1){ return (n===undefined||n===null||!isFinite(n)) ? "—" : Number(n).toFixed(d); }
  function baseLabel(d){ if (!d) return ""; if (d<=1200) return "600m"; if (d<=1600) return "800m"; return "1000m"; }
  function uniq(a){ return Array.from(new Set(a)); }

  // ===== Default base presets (per track/surface) =====
  const basePreset = {
    turn_dir: {"札幌":"右回り","函館":"右回り","福島":"右回り","新潟":"左回り","東京":"左回り","中山":"右回り","中京":"左回り","京都":"右回り","阪神":"右回り","小倉":"右回り"},
    straight_len: {
      "芝":{"東京":"長い","新潟":"長い","京都":"長い","阪神":"長い","中京":"普通","札幌":"普通","函館":"普通","福島":"短い","中山":"普通","小倉":"短い"},
      "ダ":{"東京":"普通","新潟":"普通","京都":"普通","阪神":"普通","中京":"普通","札幌":"短い","函館":"短い","福島":"短い","中山":"短い","小倉":"短い"}
    },
    turf_start: {"東京":[1600],"中京":[1400]},
    finish_slope: {"札幌":"なし","函館":"あり","福島":"あり","新潟":"なし","東京":"あり","中山":"あり","中京":"あり","京都":"あり","阪神":"あり","小倉":"なし"},
    straight_len_m: {"札幌":266,"函館":262,"福島":292,"新潟":659,"東京":526,"中山":310,"中京":412,"京都":404,"阪神":473,"小倉":293},
    elevation_diff: {"札幌":0.7,"函館":3.5,"福島":1.9,"新潟":2.2,"東京":2.0,"中山":5.3,"中京":3.5,"京都":4.3,"阪神":1.8,"小倉":2.8}
  };

  // ===== Variant presets table (track,surface,variant) -> overrides =====
  function defaultVariantPresets(){
    return [
      // Examples / starting points (編集可)
      {track:"新潟", surface:"芝", variant:"外", turn_dir:"左回り", straight_len:"長い", turf_start:"", finish_slope:"なし", straight_len_m:659, elevation_diff:2.2},
      {track:"新潟", surface:"芝", variant:"内", turn_dir:"左回り", straight_len:"普通", turf_start:"", finish_slope:"なし", straight_len_m:359, elevation_diff:2.2},
      {track:"阪神", surface:"芝", variant:"外", turn_dir:"右回り", straight_len:"長い", turf_start:"", finish_slope:"あり", straight_len_m:473, elevation_diff:1.8},
      {track:"阪神", surface:"芝", variant:"内", turn_dir:"右回り", straight_len:"短い", turf_start:"", finish_slope:"あり", straight_len_m:356, elevation_diff:1.8},
      {track:"京都", surface:"芝", variant:"外", turn_dir:"右回り", straight_len:"長い", turf_start:"", finish_slope:"あり", straight_len_m:404, elevation_diff:4.3},
      {track:"京都", surface:"芝", variant:"内", turn_dir:"右回り", straight_len:"普通", turf_start:"", finish_slope:"あり", straight_len_m:357, elevation_diff:4.3},
      // Rails (Tokyo A/B/C/D: straight lengthは大差ないため数値はベースを使用。必要なら編集)
      {track:"東京", surface:"芝", variant:"A", turn_dir:"左回り", straight_len:"長い", turf_start:"", finish_slope:"あり", straight_len_m:526, elevation_diff:2.0},
      {track:"東京", surface:"芝", variant:"B", turn_dir:"左回り", straight_len:"長い", turf_start:"", finish_slope:"あり", straight_len_m:526, elevation_diff:2.0},
      {track:"東京", surface:"芝", variant:"C", turn_dir:"左回り", straight_len:"長い", turf_start:"", finish_slope:"あり", straight_len_m:526, elevation_diff:2.0},
      {track:"東京", surface:"芝", variant:"D", turn_dir:"左回り", straight_len:"長い", turf_start:"", finish_slope:"あり", straight_len_m:526, elevation_diff:2.0},
    ];
  }

  function loadVariantPresets(){
    try{ const js = JSON.parse(localStorage.getItem(presetLS)); if (Array.isArray(js)) return js; }catch{}
    const d = defaultVariantPresets(); localStorage.setItem(presetLS, JSON.stringify(d)); return d;
  }
  function saveVariantPresets(arr){ localStorage.setItem(presetLS, JSON.stringify(arr)); }

  function applyPresetsToRow(r, presets){
    // Special case: Niigata T1000 is straight course
    if (r.track==="新潟" && r.surface==="芝" && Number(r.distance)===1000){ r.turn_dir="直線"; }
    // Find variant override first
    const v = (r.course_variant||"").trim();
    const hit = presets.find(p=> p.track===r.track && p.surface===r.surface && (p.variant||"")===v);
    const setIfEmpty = (k, val)=>{ if (r[k]===undefined || r[k]==="" || (typeof r[k]==="number" && !isFinite(r[k]))) r[k]=val; };

    if (hit){
      setIfEmpty("turn_dir", hit.turn_dir);
      setIfEmpty("straight_len", hit.straight_len);
      if (hit.turf_start==="true") r.turf_start = true;
      if (hit.turf_start==="false") r.turf_start = false;
      setIfEmpty("finish_slope", hit.finish_slope);
      setIfEmpty("straight_len_m", Number(hit.straight_len_m));
      setIfEmpty("elevation_diff", Number(hit.elevation_diff));
    }else{
      // fall back to base presets
      setIfEmpty("turn_dir", basePreset.turn_dir[r.track]);
      const map = basePreset.straight_len[r.surface]||{}; setIfEmpty("straight_len", map[r.track]);
      setIfEmpty("finish_slope", basePreset.finish_slope[r.track]);
      setIfEmpty("straight_len_m", basePreset.straight_len_m[r.track]);
      setIfEmpty("elevation_diff", basePreset.elevation_diff[r.track]);
    }
    // turf start (dirt known combos)
    if (r.surface==="ダ"){
      const list = basePreset.turf_start[r.track]||[];
      if (list.includes(Number(r.distance))) r.turf_start = true;
    }
    return r;
  }

  let rows = load();
  let variantPresets = loadVariantPresets();
  const state = {track:null, surface:null, distance:null};

  // Build track buttons
  const segT = $("#segTrack");
  tracks.forEach(t=>{
    const b=document.createElement("button"); b.textContent=t; b.dataset.track=t;
    b.onclick=()=>{ $$("#segTrack button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); state.track=t; renderDistances(); update(); };
    segT.appendChild(b);
  });
  // Surface
  $$("#segSurface button").forEach(b=> b.onclick=()=>{ $$("#segSurface button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); state.surface=b.dataset.surface; renderDistances(); update(); });

  // Filters
  $("#fTurf").addEventListener("change", update);
  $("#fStraight").addEventListener("change", update);
  $("#fShape").addEventListener("change", update);
  $("#fTurn").addEventListener("change", update);
  $("#fVariant").addEventListener("change", update);

  function renderDistances(){
    const seg=$("#segDistance"); seg.innerHTML="";
    let ds=[];
    if (state.track && state.surface){
      ds = uniq(rows.filter(r=> r.track===state.track && r.surface===state.surface).map(r=> Number(r.distance)).filter(Boolean)).sort((a,b)=>a-b);
      $("#distanceNote").textContent = ds.length? "（この場×馬場のCSV内の距離のみ表示）" : "（CSV未読込：代表的な距離を表示）";
    }
    if (ds.length===0){ ds=[1000,1100,1150,1200,1300,1400,1500,1600,1700,1800,1900,2000,2100,2200,2300,2400,2500,3000]; }
    ds.forEach(d=>{
      const b=document.createElement("button"); b.textContent=d; b.dataset.distance=d;
      b.onclick=()=>{ $$("#segDistance button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); state.distance=Number(d); update(); };
      seg.appendChild(b);
    });
  }

  function applyFilters(r){
    const fT = $("#fTurf").value;
    const fS = $("#fStraight").value;
    const fC = $("#fShape").value;
    const fR = $("#fTurn").value;
    const fV = $("#fVariant").value;
    if (fT!=="" && String(r.turf_start) !== fT) return false;
    if (fS!=="" && (r.straight_len||"") !== fS) return false;
    if (fC!=="" && (r.course_shape||"") !== fC) return false;
    if (fR!=="" && (r.turn_dir||"") !== fR) return false;
    if (fV!=="" && (r.course_variant||"") !== fV) return false;
    return true;
  }

  function filtered(){
    return rows.filter(r=> (!state.track || r.track===state.track) && (!state.surface || r.surface===state.surface) && (!state.distance || Number(r.distance)===Number(state.distance)) && applyFilters(r));
  }

  function update(){
    const arr = filtered();
    const panel = $("#panel");
    if (!state.track || !state.surface || !state.distance){ panel.style.display="none"; return; }
    panel.style.display="";
    $("#title").textContent = `${state.track}・${state.surface}・${state.distance}m`;
    $("#count").textContent = `${arr.length} 件`;
    $("#base").textContent = baseLabel(state.distance)||"—";

    const avg = (a)=> a.length? a.reduce((s,v)=>s+v,0)/a.length : NaN;
    const nums = (k)=> arr.map(x=>x[k]).filter(v=>isFinite(v));
    const passAvg=avg(nums("pass")), lastAvg=avg(nums("last3f")), cvAvg=avg(nums("cushion")), moAvg=avg(nums("moisture"));
    $("#avgPass").textContent=fmt(passAvg);
    $("#avgLast3f").textContent=fmt(lastAvg);
    $("#avgCv").textContent=fmt(cvAvg);
    $("#avgMoist").textContent=fmt(moAvg);
    let delta; if (isFinite(passAvg) && isFinite(lastAvg)){ const baseM = state.distance<=1200?600: state.distance<=1600?800:1000; delta = (lastAvg/3) - (passAvg/(baseM/200)); }
    let pace="—"; if (isFinite(delta)){ if (delta<-0.3) pace="H"; else if (delta>0.3) pace="S"; else pace="M"; }
    $("#pace").innerHTML = `<span class="tag">${pace}</span>`;

    // Details
    const tbody=$("#tbl tbody"); tbody.innerHTML="";
    arr.slice(0,800).forEach(r=>{
      const tags = [];
      if (r.course_variant) tags.push("Var:"+r.course_variant);
      if (typeof r.turf_start==="boolean") tags.push(r.turf_start? "芝S":"土S");
      if (r.straight_len) tags.push("直線:"+r.straight_len);
      if (r.turn_dir) tags.push(r.turn_dir);
      if (r.course_shape) tags.push(r.course_shape);
      if (r.finish_slope) tags.push("坂:"+r.finish_slope);
      if (isFinite(r.straight_len_m)) tags.push(`直線距離:${r.straight_len_m}m`);
      if (isFinite(r.elevation_diff)) tags.push(`高低差:${r.elevation_diff}m`);
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${r.date||""}</td><td>${r.track||""}</td><td>${r.surface||""}</td><td class="right">${r.distance||""}</td><td>${baseLabel(Number(r.distance)||0)}</td><td>${r.course_variant||""}</td><td class="right">${fmt(r.pass)}</td><td class="right">${fmt(r.last3f)}</td><td class="right">${fmt(r.cushion)}</td><td class="right">${fmt(r.moisture)}</td><td>${r.going||""}</td><td>${r.course||""}</td><td>${tags.map(x=>`<span class='tag'>${x}</span>`).join(" ")}</td>`;
      tbody.appendChild(tr);
    });
  }

  // CSV import/export
  document.getElementById("a_export").onclick=()=>{
    const header=["date","track","surface","distance","pass","last3f","cushion","moisture","going","course","course_variant","turf_start","straight_len","course_shape","turn_dir","finish_slope","straight_len_m","elevation_diff"];
    const lines=[header.join(",")].concat(rows.map(r=> header.map(k=> {
      const v = r[k]; if (typeof v==="boolean") return v? "true":"false"; return v??"";
    }).join(",")));
    const blob=new Blob([lines.join("\\n")],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="keiba_rows_v10.csv"; a.click(); URL.revokeObjectURL(url);
  };
  document.getElementById("a_import").addEventListener("change", e=>{
    const f=e.target.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const text=String(fr.result); const lines=text.split(/\\r?\\n/).filter(Boolean); const head=lines[0].split(",");
        const idx=k=> head.indexOf(k);
        const toNum=v=>{ const n=Number(v); return isFinite(n)?n:undefined; };
        const toBool=v=> v===undefined? undefined : (String(v).toLowerCase()==="true");
        rows = lines.slice(1).map(line=>{
          const c=line.split(",");
          return {
            date:c[idx("date")]||"", track:c[idx("track")]||"", surface:c[idx("surface")]||"",
            distance: toNum(c[idx("distance")]), pass: toNum(c[idx("pass")]), last3f: toNum(c[idx("last3f")]),
            cushion: toNum(c[idx("cushion")]), moisture: toNum(c[idx("moisture")]), going:c[idx("going")]||"", course:c[idx("course")]||"",
            course_variant: (idx("course_variant")>=0? (c[idx("course_variant")]||"") : ""),
            turf_start: (idx("turf_start")>=0? toBool(c[idx("turf_start")]) : undefined),
            straight_len: (idx("straight_len")>=0? (c[idx("straight_len")]||"") : ""),
            course_shape: (idx("course_shape")>=0? (c[idx("course_shape")]||"") : ""),
            turn_dir: (idx("turn_dir")>=0? (c[idx("turn_dir")]||"") : ""),
            finish_slope: (idx("finish_slope")>=0? (c[idx("finish_slope")]||"") : ""),
            straight_len_m: (idx("straight_len_m")>=0? toNum(c[idx("straight_len_m")]) : undefined),
            elevation_diff: (idx("elevation_diff")>=0? toNum(c[idx("elevation_diff")]) : undefined)
          };
        }).filter(r=> r.track && r.surface && r.distance);
        save(rows); renderDistances(); update(); alert("CSVを読み込みました");
      }catch(err){ alert("CSV読み込みエラー: "+err); }
      e.target.value="";
    };
    fr.readAsText(f);
  });
  document.getElementById("a_clear").onclick=()=>{ if(confirm("全データを削除しますか？")){ rows=[]; save(rows); renderDistances(); update(); } };

  // Preset apply
  document.getElementById("a_preset").onclick=()=>{
    if (!rows.length){ alert("先にCSVを読み込むか、データを追加してください。"); return; }
    let changed=0;
    rows = rows.map(r=>{
      const before = JSON.stringify([r.turn_dir,r.straight_len,r.turf_start,r.finish_slope,r.straight_len_m,r.elevation_diff]);
      const out = applyPresetsToRow({...r}, variantPresets);
      const after = JSON.stringify([out.turn_dir,out.straight_len,out.turf_start,out.finish_slope,out.straight_len_m,out.elevation_diff]);
      if (before!==after) changed++;
      return out;
    });
    save(rows); renderDistances(); update();
    alert(`プリセットを適用しました（更新 ${changed} 件）`);
  };

  // Manual add
  $("#btnAdd").onclick=()=>{
    let rec = {
      date: $("#inDate").value.trim(),
      track: $("#inTrack").value.trim(),
      surface: $("#inSurface").value,
      distance: Number($("#inDistance").value)||undefined,
      course_variant: $("#inVariant").value || "",
      pass: $("#inPass").value===""? undefined : Number($("#inPass").value),
      last3f: $("#inLast3f").value===""? undefined : Number($("#inLast3f").value),
      cushion: $("#inCv").value===""? undefined : Number($("#inCv").value),
      moisture: $("#inMo").value===""? undefined : Number($("#inMo").value),
      going: $("#inGoing").value.trim(),
      course: $("#inCourse").value.trim(),
      turf_start: (function(v){ if(v==="") return undefined; return v==="true"; })($("#inTurf").value),
      straight_len: $("#inStraight").value || "",
      course_shape: $("#inShape").value || "",
      turn_dir: $("#inTurn").value || "",
      finish_slope: $("#inSlope").value || "",
      straight_len_m: $("#inStraightM").value===""? undefined : Number($("#inStraightM").value),
      elevation_diff: $("#inElev").value===""? undefined : Number($("#inElev").value)
    };
    if (!rec.track || !rec.surface || !rec.distance){ alert("場・馬場・距離は必須"); return; }
    rec = applyPresetsToRow(rec, variantPresets);
    rows = [rec, ...rows]; save(rows);
    ["inDate","inTrack","inDistance","inPass","inLast3f","inCv","inMo","inGoing","inCourse","inStraightM","inElev"].forEach(id=> $("#"+id).value="");
    $("#inVariant").value=""; $("#inTurf").value=""; $("#inStraight").value=""; $("#inShape").value=""; $("#inTurn").value=""; $("#inSlope").value="";
    renderDistances(); update(); alert("追加しました（プリセット適用済）");
  };

  // ===== Preset table UI =====
  function renderPresetTable(){
    const tbody = $("#p_tbl tbody"); tbody.innerHTML="";
    variantPresets.forEach((p,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><input value="${p.track||""}" data-k="track"></td>
        <td><select data-k="surface"><option ${p.surface==="芝"?"selected":""}>芝</option><option ${p.surface==="ダ"?"selected":""}>ダ</option></select></td>
        <td><input value="${p.variant||""}" placeholder="内/外/A/B/C/D" data-k="variant" style="width:80px"></td>
        <td><select data-k="turn_dir"><option ${p.turn_dir==="右回り"?"selected":""}>右回り</option><option ${p.turn_dir==="左回り"?"selected":""}>左回り</option><option ${p.turn_dir==="直線"?"selected":""}>直線</option></select></td>
        <td><select data-k="straight_len"><option ${p.straight_len==="長い"?"selected":""}>長い</option><option ${p.straight_len==="普通"?"selected":""}>普通</option><option ${p.straight_len==="短い"?"selected":""}>短い</option></select></td>
        <td><select data-k="turf_start"><option value="" ${!p.turf_start?"selected":""}>—</option><option value="true" ${p.turf_start==="true"?"selected":""}>あり</option><option value="false" ${p.turf_start==="false"?"selected":""}>なし</option></select></td>
        <td><select data-k="finish_slope"><option ${p.finish_slope==="あり"?"selected":""}>あり</option><option ${p.finish_slope==="なし"?"selected":""}>なし</option></select></td>
        <td><input type="number" step="1" value="${p.straight_len_m??""}" data-k="straight_len_m" style="width:100px"></td>
        <td><input type="number" step="0.1" value="${p.elevation_diff??""}" data-k="elevation_diff" style="width:100px"></td>
      `;
      // events
      tr.querySelectorAll("input,select").forEach(inp=>{
        inp.addEventListener("change", ()=>{
          const k = inp.dataset.k;
          let v = inp.value;
          if (k==="straight_len_m" || k==="elevation_diff"){ v = v===""? "" : Number(v); }
          variantPresets[i][k] = v;
          saveVariantPresets(variantPresets);
        });
      });
      tbody.appendChild(tr);
    });
    // Add row button
    const trAdd=document.createElement("tr");
    const td=document.createElement("td"); td.colSpan=9;
    const btn=document.createElement("button"); btn.textContent="行を追加";
    btn.onclick=()=>{ variantPresets.push({track:"",surface:"芝",variant:"",turn_dir:"右回り",straight_len:"普通",turf_start:"",finish_slope:"あり",straight_len_m:"",elevation_diff:""}); saveVariantPresets(variantPresets); renderPresetTable(); };
    td.appendChild(btn); trAdd.appendChild(td); tbody.appendChild(trAdd);
  }
  renderPresetTable();

  $("#p_export").onclick=()=>{
    const blob=new Blob([JSON.stringify(variantPresets,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="course_presets.json"; a.click(); URL.revokeObjectURL(url);
  };
  $("#p_import").addEventListener("change", e=>{
    const f=e.target.files[0]; if(!f) return; const fr=new FileReader();
    fr.onload=()=>{ try{ const js=JSON.parse(String(fr.result)); if(Array.isArray(js)){ variantPresets=js; saveVariantPresets(variantPresets); renderPresetTable(); alert("プリセットを読み込みました"); } else { alert("JSON形式が不正です"); } }catch(err){ alert("読み込みエラー: "+err); } e.target.value=""; };
    fr.readAsText(f);
  });
  $("#p_reset").onclick=()=>{ if(confirm("初期プリセットに戻しますか？")){ variantPresets=defaultVariantPresets(); saveVariantPresets(variantPresets); renderPresetTable(); } };

  // default select
  setTimeout(()=>{ $$("#segTrack button")[0]?.click(); $$("#segSurface button")[0]?.click(); },0);
})();
</script>
</body>
</html>
